No fluff. Here‚Äôs a complete, beginner-friendly spec for the **Release Risk Analyzer (CI/CD Governance)** that TPMs can run with plain text inputs in under an hour.

# 1) Problem & Success Criteria

**Problem:** TPMs need a fast, explainable, automated check of **release readiness** from a PR or change note.

**Success =** For a given PR text:

* Agents run **sequentially** and output:

  1. a concise **change summary**
  2. structured **policy findings**
  3. a transparent **Go/No-Go** with **risk_score (0‚Äì100)** and rationale
* Works **offline** (rules only) and improves with **LLM on** (optional).

---

# 2) Agents (Responsibilities, I/O, Rules, Prompts)

## A. üìã Change Log Summarizer

**Purpose:** Turn a PR body/diff-like text into structured bullets: what changed, where, why, potential risks.

**Inputs (text):**

* `pr.title: str`
* `pr.body: str`
* `pr.files: list[str]` (optional; file paths or modules touched)

**Outputs (JSON):**

```json
{
  "summary": {
    "highlights": ["..."],
    "modules_touched": ["auth/", "gateway/router.ts"],
    "risk_notes": ["touches gateway", "possible protocol change"],
    "change_size": "small|medium|large"
  }
}
```

**Heuristic rules (offline):**

* `change_size`: small (<5 files), medium (5‚Äì20), large (>20) based on `files` length or keywords (‚Äúrefactor‚Äù, ‚Äúrewrite‚Äù ‚Üí bump up).
* `modules_touched`: extract top-level directories or file prefixes.
* `risk_notes`: if body contains keywords ‚Üí

  * protocol/api/version ‚Üí ‚Äúprotocol change‚Äù
  * secrets/key/token/private ‚Üí ‚Äúpossible secret exposure‚Äù
  * db/migration/sql/schema ‚Üí ‚Äúdb migration‚Äù
  * gateway/auth/payments ‚Üí ‚Äúsensitive domain‚Äù

**Optional LLM prompt (JSON mode):**

> ‚ÄúSummarize the PR into highlights (3‚Äì7 bullets), modules_touched (list of paths/names), risk_notes (short phrases), and change_size (small/medium/large). Return strict JSON with keys: highlights, modules_touched, risk_notes, change_size.‚Äù

**Fallback:** If LLM fails/missing, use heuristics only.

---

## B. ‚öôÔ∏è Policy Validator

**Purpose:** Convert summary + PR text into **policy findings** and compute a **base_risk**.

**Inputs (JSON):**

* From Summarizer: `summary`
* Original PR text fields for pattern checks

**Outputs (JSON):**

```json
{
  "findings": {
    "missing_tests": true,
    "secret_like": false,
    "risky_modules": ["auth/"],
    "db_migration_detected": false,
    "unapproved_modules": ["experimental/feature_flag_driver.py"],
    "docs_updated": false,
    "change_size": "medium",
    "policy_violations": ["tests_required", "unapproved_module"]
  },
  "risk_score_components": {
    "tests": 30,
    "risky_modules": 20,
    "secrets": 100,
    "db_migration": 15,
    "unapproved": 20,
    "docs_missing": 5,
    "size": 10
  },
  "base_risk": 55
}
```

**Rules (tune weights as needed; examples below):**

* **Missing tests**: if `files` contains `src/` or `service/` changes and **no** `tests/` or `*_test.*` ‚Üí +30
* **Risky modules**: if `modules_touched` intersects `{auth, payments, gateway, encryption, secrets}` ‚Üí +20
* **Secret-like**: if title/body contain `(?i)(api[_-]?key|secret|private key|-----BEGIN|AKIA[0-9A-Z]{16})` ‚Üí set **base_risk=100**, force **No-Go**
* **DB migration**: ‚Äúmigration‚Äù, ‚Äúschema‚Äù, `.sql` ‚Üí +15
* **Unapproved module**: any path under `experimental/`, `vendor/`, or flagged list ‚Üí +20
* **Docs updated**: if `docs/` touched or body mentions ‚Äúdocs updated‚Äù ‚Üí 0 else **+5** when `change_size != small`
* **Change size**: small 0, medium +10, large +20

**Optional LLM prompt (JSON mode):**

> ‚ÄúGiven the PR summary and body, identify: missing_tests (bool), risky_modules ([str]), secret_like (bool), db_migration_detected (bool), unapproved_modules ([str]), docs_updated (bool), change_size (small/medium/large), policy_violations ([str]). Also compute a base_risk integer 0‚Äì100 using the rules provided. Return strict JSON.‚Äù

**Fallback:** Always compute via rules above.

---

## C. üßë‚Äçüíº Release Decision Agent

**Purpose:** Produce final **Go/No-Go**, **risk_score**, and short **rationale**.

**Inputs (JSON):**

* `summary`, `findings`, `base_risk`

**Outputs (JSON):**

```json
{
  "decision": {
    "go": false,
    "risk_score": 78,
    "rationale": "Missing tests and unapproved module in auth/. Auto No-Go."
  }
}
```

**Decision policy (transparent, tweakable):**

1. If `secret_like == true` ‚Üí **No-Go**, `risk_score=100`, rationale: ‚ÄúPossible secret exposure‚Äù.
2. Else compute **adjusted_risk = base_risk + conditional bumps**:

   * If `risky_modules` and `missing_tests` ‚Üí **+15**
   * If `db_migration_detected` and `docs_updated=false` ‚Üí **+10**
   * Cap at 100.
3. Thresholds (teachable):

   * `risk_score < 40` ‚Üí **Go**
   * `40‚Äì69` ‚Üí **Go with caution** (print risks); for the class, treat as **Go**
   * `‚â• 70` ‚Üí **No-Go**

**Optional LLM prompt (JSON mode):**

> ‚ÄúGiven the policy findings and base_risk, compute the final risk_score (0‚Äì100) using the provided rules and recommend Go/No-Go with a one-sentence rationale. Return strict JSON with keys: risk_score, go (bool), rationale.‚Äù

**Fallback:** Deterministic policy above.

---

# 3) Pydantic Schemas (beginner-friendly)

```python
class PRInput(BaseModel):
    title: str
    body: str
    files: List[str] = []

class Summary(BaseModel):
    highlights: List[str]
    modules_touched: List[str]
    risk_notes: List[str]
    change_size: Literal["small","medium","large"]

class PolicyFindings(BaseModel):
    missing_tests: bool
    secret_like: bool
    risky_modules: List[str]
    db_migration_detected: bool
    unapproved_modules: List[str]
    docs_updated: bool
    change_size: Literal["small","medium","large"]
    policy_violations: List[str]

class RiskComponents(BaseModel):
    tests: int = 0
    risky_modules: int = 0
    secrets: int = 0
    db_migration: int = 0
    unapproved: int = 0
    docs_missing: int = 0
    size: int = 0

class ValidatorOutput(BaseModel):
    findings: PolicyFindings
    risk_score_components: RiskComponents
    base_risk: int

class Decision(BaseModel):
    go: bool
    risk_score: int
    rationale: str
```

---

# 4) Scoring Cheat-Sheet (print on a slide)

* Missing tests +30
* Risky modules +20
* Secret-like ‚Üí **100, No-Go**
* DB migration +15
* Unapproved module +20
* Docs missing (non-small) +5
* Size: medium +10, large +20
* **Conditional bump**: risky_modules **and** missing_tests +15
* **Conditional bump**: db_migration **and** docs_missing +10
* **Final thresholds**: `<40 Go`, `40‚Äì69 Go (caution)`, `‚â•70 No-Go`

---

# 5) Hands-On Classroom Flow (no APIs)

**Setup (5 min)**

* Provide three sample PRs (below) as plain text.
* Split class into 3 tables; each table is one ‚Äúagent‚Äù for round 1.

**Round 1 (15 min) ‚Äì Manual run**

* Table A runs **Summarizer** (fill template).
* Table B runs **Validator** using the rubric, returns `base_risk`.
* Table C runs **Decision** using thresholds.

**Round 2 (15 min) ‚Äì Swap & rerun with variations**

* Add/remove ‚Äútests/‚Äù file, toggle ‚Äúdocs updated‚Äù, or add ‚Äúsecret‚Äù keyword.
* Observe how the **risk score** moves and decisions flip.

**Round 3 (10 min) ‚Äì LLM assist (optional)**

* For Summarizer/Decision, show how LLM JSON outputs align with the rules, and where they help/hurt.

**Wrap (5 min)**

* Discuss thresholds/weights you‚Äôd change for your org.

---

# 6) Sample PR Inputs (copy/paste)

### PR-A (likely Go)

```
Title: Improve product search ranking for typos
Body:
- Adjust tokenization and add synonyms for common misspellings.
- Refactor ranking feature weights; no API changes.
- Docs updated in /docs/search.md
Files:
- search/ranker.py
- search/tokenizer.py
- docs/search.md
- tests/test_ranker.py
```

### PR-B (Go with caution or No-Go if strict)

```
Title: Add payment retries in gateway
Body:
- Introduce idempotency keys for retries.
- Touches gateway router and card processing path.
- Will add tests in follow-up PR.
Files:
- gateway/router.ts
- payments/processor.ts
```

### PR-C (Auto No-Go)

```
Title: Update keys for staging
Body:
- Temporary secret for partner testing: -----BEGIN PRIVATE KEY-----
- Revert before prod cut.
Files:
- config/staging.env
```

### PR-D (Medium risk due to migration & docs missing)

```
Title: Catalog DB migration for SKU indexing
Body:
- Adds SKU index and changes varchar length.
- No public API change; updates ORM model.
- (Docs pending)
Files:
- services/catalog/models.py
- migrations/2025_10_29_add_sku_index.sql
```

### PR-E (Unapproved module)

```
Title: Experiment: feature flag driver for A/B infra
Body:
- Introduces experimental driver for flag rollout.
- Not on the approved module list yet.
Files:
- experimental/feature_flag_driver.py
- services/flags/router.py
```

---

# 7) Example End-to-End Output (for PR-B)

```json
{
  "summary": {
    "highlights": [
      "Add idempotent retry to payment flow",
      "Touches gateway router and card processing"
    ],
    "modules_touched": ["gateway/", "payments/"],
    "risk_notes": ["sensitive domain (gateway, payments)"],
    "change_size": "small"
  },
  "findings": {
    "missing_tests": true,
    "secret_like": false,
    "risky_modules": ["gateway/", "payments/"],
    "db_migration_detected": false,
    "unapproved_modules": [],
    "docs_updated": false,
    "change_size": "small",
    "policy_violations": ["tests_required"]
  },
  "risk_score_components": {
    "tests": 30,
    "risky_modules": 20,
    "secrets": 0,
    "db_migration": 0,
    "unapproved": 0,
    "docs_missing": 0,
    "size": 0
  },
  "base_risk": 50,
  "decision": {
    "go": false,
    "risk_score": 65,
    "rationale": "Missing tests in gateway/payments. Add tests to reduce risk."
  }
}
```

*(Here we applied an additional +15 conditional bump for ‚Äúrisky_modules AND missing_tests‚Äù ‚Üí 50+15=65)*

---

# 8) How to Visualize (no code)

* Draw three boxes on a whiteboard: **Summarize ‚Üí Validate ‚Üí Decide**.
* Below each, paste the agent‚Äôs **inputs ‚Üí outputs** as sticky notes.
* Circle the weights (30/20/15/‚Ä¶) to show how the score is built.
* Mark secret-like path in **red** to explain **Auto No-Go** guardrail.

---

# 9) Extensibility (two easy knobs)

* **Add ‚ÄúRollback Plan Checker‚Äù**: if body lacks ‚Äúrollback‚Äù when risky_modules present ‚Üí +10.
* **Add ‚ÄúCoverage Delta Reader‚Äù**: parse ‚Äúcoverage: +0.8%‚Äù in body ‚Üí subtract ‚àí5 if positive.

---

# 10) Acceptance Criteria (for the class)

* Given PR-A..E, your system:

  * Produces a **structured summary** with modules & risk notes.
  * Computes **base_risk** with components (non-zero where expected).
  * Applies **thresholds** to output **Go/No-Go** consistently.
  * Explains the decision in **one clear sentence**.

